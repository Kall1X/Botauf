#!/usr/bin/env python3
import logging
from telegram import Update
from telegram.ext import (
    Application,
    CommandHandler,
    MessageHandler,
    filters,
    CallbackContext,
    ContextTypes
)
import random
from collections import defaultdict

# Настройка логирования
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# База данных убийств
kill_stats = defaultdict(int)  # user_id: количество убийств
user_names = {}  # user_id: имя пользователя

# Статьи УК РФ
articles = [
    "Статья 105 УК РФ — Убийство. Наказание: от 6 до 15 лет, либо пожизненное.",
    "Статья 111 УК РФ — Умышленное причинение тяжкого вреда здоровью. Наказание: до 15 лет.",
    "Статья 126 УК РФ — Похищение человека. Наказание: от 5 до 15 лет.",
    "Статья 131 УК РФ — Изнасилование. Наказание: от 3 до 20 лет.",
    "Статья 132 УК РФ — Насильственные действия сексуального характера. Наказание: от 3 до 20 лет.",
    "Статья 134 УК РФ — Половое сношение с несовершеннолетним. Наказание: до 20 лет.",
    "Статья 135 УК РФ — Развратные действия. Наказание: до 15 лет.",
    "Статья 205 УК РФ — Террористический акт. Наказание: от 10 до 20 лет, либо пожизненное.",
    "Статья 205.1 УК РФ — Содействие терроризму. Наказание: от 5 до 20 лет.",
    "Статья 205.2 УК РФ — Публичные призывы к терроризму. Наказание: до 10 лет.",
    "Статья 205.3 УК РФ — Прохождение обучения в террористических целях. Наказание: до 15 лет.",
    "Статья 205.4 УК РФ — Организация террористического сообщества. Наказание: от 15 до 20 лет.",
    "Статья 205.5 УК РФ — Организация деятельности террористической организации. Наказание: от 15 до 20 лет.",
    "Статья 206 УК РФ — Захват заложников. Наказание: от 5 до 20 лет.",
    "Статья 208 УК РФ — Участие в незаконном вооружённом формировании. Наказание: до 15 лет.",
    "Статья 209 УК РФ — Бандитизм. Наказание: от 10 до 20 лет.",
    "Статья 210 УК РФ — Организация преступного сообщества. Наказание: от 10 до 20 лет.",
    "Статья 211 УК РФ — Угон судна, поезда или самолёта. Наказание: до 15 лет.",
    "Статья 212 УК РФ — Массовые беспорядки. Наказание: до 15 лет.",
    "Статья 222 УК РФ — Незаконный оборот оружия. Наказание: до 12 лет.",
    "Статья 222.1 УК РФ — Контрабанда оружия. Наказание: до 20 лет.",
    "Статья 223 УК РФ — Изготовление оружия. Наказание: до 10 лет.",
    "Статья 228 УК РФ — Незаконный оборот наркотиков. Наказание: от 3 лет до пожизненного.",
    "Статья 228.1 УК РФ — Производство и сбыт наркотиков. Наказание: от 4 лет до пожизненного.",
    "Статья 229 УК РФ — Хищение наркотиков. Наказание: до 20 лет.",
    "Статья 229.1 УК РФ — Контрабанда наркотиков. Наказание: от 5 лет до пожизненного.",
    "Статья 230 УК РФ — Склонение к потреблению наркотиков. Наказание: до 15 лет.",
    "Статья 240 УК РФ — Вовлечение в проституцию. Наказание: до 10 лет.",
    "Статья 241 УК РФ — Организация проституции. Наказание: до 15 лет.",
    "Статья 242 УК РФ — Незаконное распространение порнографии. Наказание: до 10 лет.",
    "Статья 242.1 УК РФ — Изготовление и оборот детской порнографии. Наказание: до 15 лет.",
    "Статья 275 УК РФ — Государственная измена. Наказание: от 12 до 20 лет.",
    "Статья 276 УК РФ — Шпионаж. Наказание: от 10 до 20 лет.",
    "Статья 277 УК РФ — Посягательство на жизнь государственного деятеля. Наказание: от 12 до 20 лет.",
    "Статья 278 УК РФ — Насильственный захват власти. Наказание: от 12 до 20 лет.",
    "Статья 279 УК РФ — Вооружённый мятеж. Наказание: от 12 до 20 лет.",
    "Статья 281 УК РФ — Диверсия. Наказание: от 10 до 20 лет.",
    "Статья 282 УК РФ — Возбуждение ненависти либо вражды. Наказание: до 6 лет.",
    "Статья 282.1 УК РФ — Организация экстремистского сообщества. Наказание: до 12 лет.",
    "Статья 282.2 УК РФ — Организация деятельности экстремистской организации. Наказание: до 10 лет.",
    "Статья 282.3 УК РФ — Финансирование экстремизма. Наказание: до 10 лет.",
    "Статья 285 УК РФ — Злоупотребление должностными полномочиями. Наказание: до 10 лет.",
    "Статья 286 УК РФ — Превышение должностных полномочий. Наказание: до 10 лет.",
    "Статья 290 УК РФ — Получение взятки. Наказание: до 15 лет.",
    "Статья 291 УК РФ — Дача взятки. Наказание: до 12 лет.",
    "Статья 295 УК РФ — Посягательство на жизнь правоохранителя. Наказание: до 20 лет.",
    "Статья 317 УК РФ — Посягательство на жизнь сотрудника правоохранительных органов. Наказание: до 20 лет.",
    "Статья 318 УК РФ — Применение насилия в отношении представителя власти. Наказание: до 10 лет.",
    "Статья 321 УК РФ — Дезорганизация деятельности учреждений, обеспечивающих изоляцию. Наказание: до 10 лет.",
    "Статья 322 УК РФ — Незаконное пересечение границы. Наказание: до 6 лет."
]

# Бандитские загадки
riddles = [
    "Два стула: на одном пики точены, на другом хуи дрочены. На какой сядешь, на какой мать посадишь?",
    "Ты летишь на парашюте, справа - лес хуев, слева - море говна. Куда будешь садиться?",
    "Ты упал в яму. В яме пирожок и хуй. Что съешь, что в жопу засунешь?",
    "В жопу дашь или мать продашь?",
    "Вилкой в глаз или в жопу раз?",
    "Что съешь - мыло со стола или хлеб с параши?",
    "Идешь по пустыне Сахаре с кентом. Змея кусает его за хуй. Что делать будешь?",
    "Едешь в поезде, прикованный к рычагам. Справа мать привязана, слева кенты. Куда свернешь?",
    "Сидит зек в камере, утром видят кости. Откуда кости, если зек живой?",
    "Два петуха: одного ебли до обеда, другого после. Кому было хуже?",
    "На стене ворота, на полу мяч. Говорят забить гол. Что будешь делать?",
    "Дают веник и говорят: 'Сыграй на гитаре'. Что будешь делать?",
    "Бутылку разбивают и говорят: 'Зашей'. Что будешь делать?",
    "Просят сыграть на батарее, как на баяне. Что будешь делать?",
    "Стоит столб, на столбе 12 суков, на каждом суку по 4 ветки. Сколько всего веток?",
    "Шёл по зоне, увидел три вышки. На каждой по мусору. Сколько всего ментов?",
    "В камере три угла. В одном сидит кот, в другом - сука, в третьем - петух. Где сидит зек?",
    "Дают стакан и говорят: 'Сделай из него бутылку'. Как быть?",
    "Подходит блатной и говорит: 'Дай покурить, а то в жопу дам'. Что делать?",
    "В бане мылся, мыло упало. Поднять или новое взять?",
    "Приходит пацан в камеру, а там три косяка. Какой выбрать?",
    "Стоит барак, в нём 100 коек. 99 зеков спят, один стоит. Кто стоит?",
    "Идёшь по шконе, видишь три портянки: чистую, грязную и мокрую. Какую выберешь?",
    "Дают три спички и говорят сложить 'правосудие'. Как сложишь?",
    "В камере нет света, но нужно читать. Как быть?",
    "Подходит смотрящий и говорит: 'Выбирай - или в жопу, или в рот'. Что выберешь?",
    "Видишь двух мужиков - один бьёт другого. Как понять, кто прав?",
    "Принесли баланду с тараканом. Что делать?",
    "На тумбочке лежат хлеб и мыло. Что сначала возьмёшь?",
    "Дают ложку и говорят выкопать тоннель. С чего начнёшь?",
    "В карцере три дня без воды. Как выжить?",
    "Видишь, как опускают твоего кента. Как поступишь?",
    "Приходит письмо из дома, а ты неграмотный. Как прочтёшь?",
    "Дают выбор: отсидеть год или получить в рыло. Что выберешь?",
    "В камере жарко, а открывать дверь нельзя. Как остыть?",
    "Уснул на шконе, проснулся - портянки нет. Где искать?",
    "Подходит мент и говорит: 'Сдай нож'. Что ответишь?",
    "Видишь, как опускают незнакомого зека. Вмешаешься?",
    "Дают три дня карцера или три года общего. Что выберешь?",
    "В камере пахнет жареной картошкой, но готовить негде. Откуда запах?",
    "Приходит передачка, а там только лук. Как быть?",
    "Стоит выбор: сдать сокамерника или получить пиздюлей. Что сделаешь?",
    "В тумбочке лежит последняя пачка чая. Украли или оставили?",
    "Дают карандаш и говорят нарисовать свободу. Что нарисуешь?",
    "Видишь, как блатной роняет мыло. Поднимешь?",
    "Приходит новый в камеру и сразу лезет на верхнюю шкону. Как поступишь?",
    "Слышишь, как в соседней камере стонут. Что это?",
    "Дают выбор: съесть таракана или выпить мочу. Что выберешь?",
    "Видишь, как мусор бьёт зека. Вмешаешься?",
    "Последняя пайка хлеба. Поделишься или съешь сам?"
]

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Отправляет сообщение при старте бота."""
    user = update.effective_user
    await update.message.reply_text(
        f'АУФ, {user.first_name}! Я бандитский бот.\n\n'
        'Команды:\n'
        '"Статья" - случайная статья УК РФ\n'
        '"Загадка" - бандитская загадка\n'
        'Ответь "убить" на чье-то сообщение\n'
        '/top - топ убийц\n'
        '/stats - твоя статистика'
    )

async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Обрабатывает текстовые сообщения."""
    text = update.message.text.lower()
    user = update.effective_user

    # Сохраняем имя пользователя
    user_names[user.id] = user.first_name

    # Реакция на "Статья"
    if "статья" in text:
        article = random.choice(articles)
        await update.message.reply_text(f"👨⚖️ | {user.first_name} приговаривается к {article}")

    # Реакция на "Загадка"
    elif "загадка" in text:
        riddle = random.choice(riddles)
        answer = "(Окак хуй бумажный)" if "яблок" in riddle else "(Окак чел дырявый)"
        await update.message.reply_text(f"💀 | {user.first_name}, вот тебе загадка:\n\n{riddle}\n\n{answer}")

async def handle_kill(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Обрабатывает команду 'убить' в ответ на сообщение."""
    if not update.message.reply_to_message:
        await update.message.reply_text("Нужно ответить 'убить' на чье-то сообщение!")
        return

    killer = update.effective_user
    victim = update.message.reply_to_message.from_user

    # Сохраняем имена
    user_names[killer.id] = killer.first_name
    user_names[victim.id] = victim.first_name

    # Увеличиваем счетчик убийств
    kill_stats[killer.id] += 1

    # Генерируем случайное оружие
    weapons = ["🔪 ножом", "🔫 пистолетом", "💣 гранатой", "🪓 топором", "🧨 динамитом", "🏒 битой"]
    weapon = random.choice(weapons)

    await update.message.reply_text(
        f"💀 КРИМИНАЛЬНАЯ ХРОНИКА:\n\n"
        f"{killer.first_name} {weapon} замочил {victim.first_name}!\n"
        f"Всего жертв: {kill_stats[killer.id]}"
    )

async def top_killers(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Показывает топ убийц."""
    if not kill_stats:
        await update.message.reply_text("Пока никто никого не убил!")
        return

    # Сортируем убийц по количеству убийств
    sorted_killers = sorted(kill_stats.items(), key=lambda x: x[1], reverse=True)

    # Формируем топ
    top_text = "🔫 ТОП-10 КИЛЛЕРОВ:\n\n"
    for i, (user_id, kills) in enumerate(sorted_killers[:10], 1):
        name = user_names.get(user_id, "Аноним")
        top_text += f"{i}. {name} — {kills} убийств\n"

    await update.message.reply_text(top_text)

async def user_stats(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Показывает статистику пользователя."""
    user = update.effective_user
    kills = kill_stats.get(user.id, 0)

    await update.message.reply_text(
        f"📊 ТВОЯ СТАТИСТИКА:\n\n"
        f"Имя: {user.first_name}\n"
        f"Убийств: {kills}\n"
        f"Место в топе: {get_rank(user.id)}"
    )

def get_rank(user_id: int) -> str:
    """Возвращает место в топе."""
    if user_id not in kill_stats:
        return "не в топе"

    sorted_killers = sorted(kill_stats.items(), key=lambda x: x[1], reverse=True)
    user_ids = [u[0] for u in sorted_killers]

    position = user_ids.index(user_id) + 1
    if position == 1:
        return "🥇 1 место"
    elif position == 2:
        return "🥈 2 место"
    elif position == 3:
        return "🥉 3 место"
    else:
        return f"{position} место"

def main() -> None:
    """Запускает бота."""
    # Создаем Application
    application = Application.builder().token("7959174236:AAFKFdhre7nOOmnKk3Q2ILotwTW80UzQDiA").build()

    # Регистрируем обработчики команд
    application.add_handler(CommandHandler("start", start))
    application.add_handler(CommandHandler("top", top_killers))
    application.add_handler(CommandHandler("stats", user_stats))

    # Регистрируем обработчики сообщений
    application.add_handler(MessageHandler(
        filters.TEXT & ~filters.COMMAND & filters.Regex(r'статья|загадка'),
        handle_message
    ))

    # Обработчик для команды "убить"
    application.add_handler(MessageHandler(
        filters.TEXT & ~filters.COMMAND & filters.Regex(r'убить') & filters.REPLY,
        handle_kill
    ))

    # Запускаем бота
    application.run_polling()

if __name__ == '__main__':
    main()
